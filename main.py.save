from fastapi import FastAPI, UploadFile, File, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
import os
import random
import uuid
import shutil

app = FastAPI()

# --- CORS (viktigt för WebView / Capacitor) ---
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

BASE_DIR = os.path.dirname(__file__)
FALLBACK_DIR = os.path.join(BASE_DIR, "fallback")
UPLOAD_DIR = os.path.join(BASE_DIR, "uploads")

os.makedirs(FALLBACK_DIR, exist_ok=True)
os.makedirs(UPLOAD_DIR, exist_ok=True)


# ---------- HEALTH ----------
@app.get("/health")
def health():
    return {"status": "ok"}


# ---------- INFO (valfritt, men din app frågar efter detta) ----------
@app.get("/object_info")
def object_info():
    return {"backend": "cpu", "mode": "fallback"}


@app.get("/queue/status")
def queue_status():
    return {"running": False, "queue": 0}


# ---------- UPLOAD IMAGE ----------
@app.post("/upload/image")
async def upload_image(image: UploadFile = File(...)):
    try:
        ext = os.path.splitext(image.filename or "")[1] or ".png"
        filename = f"{uuid.uuid4().hex}{ext}"
        path = os.path.join(UPLOAD_DIR, filename)

        with open(path, "wb") as f:
            shutil.copyfileobj(image.file, f)

        return {"ok": True, "filename": filename}
    except Exception as e:
        return JSONResponse(
            status_code=500,
            content={"ok": False, "error": str(e)}
        )


# ---------- PROMPT / GENERATE ----------
@app.post("/prompt")
async def prompt(payload: dict):
    images = [ f"https://www.wemmstudios.se/galax-fallback/hero_{i:02d}.png" for i in range(1, 16) ]f for f in os.listdir(FALLBACK_DIR) if f.lower().endswith(".png")
    
chosen = random.choice(images)    ])

    if not files:
        return JSONResponse(
            status_code=500,
            content={
                "ok": False, 
                "error": "No fallback images"
            }
        )

    chosen = random.choice(files) 

    base = str(request.base_url).rstrip("/")
    image_url = f"{base}/fallback/{chosen}"

    return {
        "ok": True,
        "image": image_url,
        "source": "fallback"
    }


# ---------- SERVE FALLBACK IMAGES ----------
from fastapi.staticfiles import StaticFiles
app.mount("/fallback", StaticFiles(directory=FALLBACK_DIR), name="fallback")
